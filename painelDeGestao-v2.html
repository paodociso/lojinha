<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo | P√£o do Ciso</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-creme: #fdf5e6;
            --verde-militar: #2d3a27;
            --marrom-cafe: #2e2610;
            --marrom-detalhe: #7d4f39;
            --texto: #3e2723;
            --branco: #ffffff;
            --red: #b22222;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            background: #f4f1ea;
            color: var(--texto);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--verde-militar);
            height: 100vh;
            position: fixed;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header img {
            width: 90px;
            border-radius: 50%;
            border: 3px solid var(--bg-creme);
            margin-bottom: 15px;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: 0.3s;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 5px solid var(--bg-creme);
        }

        /* Main Area */
        .main {
            margin-left: 260px;
            flex: 1;
            padding: 40px;
            min-height: 100vh;
        }

        .card-admin {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            text-align: left;
            padding: 15px;
            background: #f8f9fa;
            color: var(--marrom-cafe);
            border-bottom: 2px solid #eee;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            word-wrap: break-word;
        }

        .col-img { width: 70px; }
        .col-preco { width: 110px; }
        .col-status { width: 110px; }
        .col-acoes { width: 140px; }

        /* Buttons */
        .btn-adm {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-verde-personalizado { background: var(--verde-militar); color: white; }
        .btn-bege-personalizado { background: var(--bg-creme); color: var(--verde-militar); border: 1px solid #dccbb0; }
        .btn-red { background: var(--red); color: white; }

        /* Badges */
        .badge { padding: 5px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-error { background: #f8d7da; color: #721c24; }

        .badge-opcional-micro {
            font-size: 0.65rem;
            padding: 2px 8px;
            background: #eee;
            border-radius: 10px;
            color: var(--verde-militar);
            border: 1px solid #ddd;
        }

        .badge-opcional {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 0.8rem;
            background: #fff;
        }

        .badge-opcional.selected {
            background: var(--verde-militar);
            color: white;
        }

        .opcionais-badge-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white; width: 550px; padding: 40px; border-radius: 20px;
            max-height: 90vh; overflow-y: auto;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .card-button { background: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.3s; }
        .card-button:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        /* NOVOS ESTILOS: BOT√ïES DE STATUS E DRAG-AND-DROP */
        /* 1. Bot√µes de Visibilidade e Estoque */
        .btn-status-icon {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            transition: 0.2s;
        }

        .btn-status-icon:hover {
            transform: scale(1.2);
        }

        /* 2. Base do Arraste */
        .linha-movivel {
            cursor: grab;
            transition: transform 0.2s;
        }

        /* 3. Efeito de Retra√ß√£o (Quando estiver arrastando) */
        .card-admin.dragging {
            opacity: 0.8;
            background: var(--bg-creme) !important;
            border: 2px dashed var(--marrom-detalhe) !important;
            height: 70px !important; /* Altura pequena para caber v√°rias na tela */
            overflow: hidden; /* Esconde o que vazar (tabela, bot√µes, etc) */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Garante que o t√≠tulo da se√ß√£o continue vis√≠vel na retra√ß√£o */
        .card-admin.dragging h2 {
            margin: 0;
            padding: 10px;
        }

        /* Esconde a tabela e outros elementos internos durante o arraste */
        .card-admin.dragging table, 
        .card-admin.dragging button:not(.btn-status-icon), 
        .card-admin.dragging .opcionais-badge-container {
            display: none !important;
        }

        .container-cupons-lista {
        margin-top: 10px;
        padding: 15px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="https://cdn3.emoji.gg/emojis/2637-settings.png" alt="Logo">
            <h3>Painel P√£o do Ciso</h3>
        </div>
        <nav>
            <div class="nav-item" id="nav-dashboard" onclick="navegarPara('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
            <div class="nav-item" id="nav-produtos" onclick="navegarPara('produtos')"><i class="fas fa-bread-slice"></i> Produtos</div>
            <div class="nav-item" id="nav-sessoes" onclick="navegarPara('sessoes')"><i class="fas fa-folder-open"></i> Sess√µes</div>
            <div class="nav-item" id="nav-cupons" onclick="navegarPara('cupons')"><i class="fas fa-ticket-alt"></i> Cupons</div>
            <div style="padding: 20px;">
                <button class="btn-adm btn-bege-personalizado" style="width:100%" onclick="visualizarCodigo()">Ver C√≥digo</button>
                <button class="btn-adm btn-verde-personalizado" style="width:100%; margin-top:10px" onclick="baixarDados()">Baixar dados.js</button>
            </div>
        </nav>
    </aside>

    <main class="main">
        <div id="content-area"></div>
    </main>

    <div id="modal-container" class="modal-overlay" onclick="if(event.target === this) fecharModal()">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <div id="modal-body"></div>
        </div>
    </div>

    <script src="dados.js"></script>
    <script>
let db = JSON.parse(localStorage.getItem('pao_do_ciso_db')) || dadosIniciais;
        let opcionaisTemp = [];
        let secaoAtiva = 'dashboard';

        const persistir = () => localStorage.setItem('pao_do_ciso_db', JSON.stringify(db));

        const CRUD = {
            atualizarEListar: () => { persistir(); renderizarAtual(); },

            salvarFornada: (dados) => {
                db.fornada = { dataISO: dados.dataISO, diasAntecedencia: parseInt(dados.diasAntecedencia), horaLimite: dados.horaLimite };
                CRUD.atualizarEListar();
                alert("Fornada atualizada!");
            },

            toggleVisibilidade: (sIdx, iIdx) => {
                const item = db.secoes[sIdx].itens[iIdx];
                item.visivel = item.visivel === false; 
                CRUD.atualizarEListar();
            },

            toggleDisponibilidade: (sIdx, iIdx) => {
                const item = db.secoes[sIdx].itens[iIdx];
                item.disponivel = item.disponivel === false;
                CRUD.atualizarEListar();
            },

            salvarProduto: (sIdx, iIdx) => {
                const nome = document.getElementById('f-nome').value;
                const descricao = document.getElementById('f-descricao').value;
                const imagem = document.getElementById('f-imagem').value;
                const preco = parseFloat(document.getElementById('f-preco').value);
                const visivel = document.getElementById('f-visivel').checked;
                const disponivel = document.getElementById('f-disponivel').checked;

                const item = { 
                    nome, 
                    descricao, 
                    imagem, 
                    preco, 
                    opcionais_ativos: opcionaisTemp,
                    visivel,
                    disponivel
                };

                if (iIdx !== null) db.secoes[sIdx].itens[iIdx] = item;
                else db.secoes[sIdx].itens.push(item);

                fecharModal();
                CRUD.atualizarEListar();
            },

            removerProduto: (sIdx, iIdx) => {
                if (confirm("Excluir produto?")) { db.secoes[sIdx].itens.splice(iIdx, 1); CRUD.atualizarEListar(); }
            },

            toggleVisibilidade: (sIdx, iIdx) => {
                // Se o campo n√£o existir, assume true e inverte. 
                const atual = db.secoes[sIdx].itens[iIdx].visivel !== false;
                db.secoes[sIdx].itens[iIdx].visivel = !atual;
                CRUD.atualizarEListar();
            },

            toggleDisponibilidade: (sIdx, iIdx) => {
                // Se o campo n√£o existir, assume true e inverte.
                const atual = db.secoes[sIdx].itens[iIdx].disponivel !== false;
                db.secoes[sIdx].itens[iIdx].disponivel = !atual;
                CRUD.atualizarEListar();
            },

            toggleVisibilidade: (sIdx, iIdx) => {
                // Se o campo n√£o existir, assume true e inverte. 
                const atual = db.secoes[sIdx].itens[iIdx].visivel !== false;
                db.secoes[sIdx].itens[iIdx].visivel = !atual;
                CRUD.atualizarEListar();
            },

            toggleDisponibilidade: (sIdx, iIdx) => {
                // Se o campo n√£o existir, assume true e inverte.
                const atual = db.secoes[sIdx].itens[iIdx].disponivel !== false;
                db.secoes[sIdx].itens[iIdx].disponivel = !atual;
                CRUD.atualizarEListar();
            },

            salvarSessao: (idx, nome) => {
                if (idx !== null) db.secoes[idx].nome = nome;
                else db.secoes.push({ nome: nome, itens: [] });
                fecharModal();
                CRUD.atualizarEListar();
            },

            removerSessao: (idx) => {
                if (confirm("Excluir sess√£o?")) { db.secoes.splice(idx, 1); CRUD.atualizarEListar(); }
            },

            adicionarOpcional: (nomeSessao, sIdx) => {
                if (!db.opcionais[nomeSessao]) db.opcionais[nomeSessao] = [];
                db.opcionais[nomeSessao].push({ nome: "Novo Opcional", preco: 0 });
                persistir();
                abrirModalSessao(sIdx);
            },

            editarOpcional: (nomeSessao, oIdx, campo, valor) => {
                db.opcionais[nomeSessao][oIdx][campo] = campo === 'preco' ? parseFloat(valor) : valor;
                persistir();
            },

            removerOpcional: (nomeSessao, oIdx, sIdx) => {
                db.opcionais[nomeSessao].splice(oIdx, 1);
                persistir();
                abrirModalSessao(sIdx);
            },

            salvarCupom: () => {
                const codigo = document.getElementById('f-cupom-codigo').value.toUpperCase();
                db.cupons.push({ codigo, tipo: document.getElementById('f-cupom-tipo').value, valor: parseFloat(document.getElementById('f-cupom-valor').value) });
                fecharModal();
                CRUD.atualizarEListar();
            },

            removerCupom: (idx) => { if (confirm("Excluir cupom?")) { db.cupons.splice(idx, 1); CRUD.atualizarEListar(); } }
        };

        const navegarPara = (secao) => {
            secaoAtiva = secao;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + secao).classList.add('active');
            renderizarAtual();
        };

        const renderizarAtual = () => {
            const container = document.getElementById('content-area');
            container.innerHTML = '';
            if (secaoAtiva === 'dashboard') renderDashboard(container);
            else if (secaoAtiva === 'produtos') renderProdutos(container);
            else if (secaoAtiva === 'sessoes') renderSessoes(container);
            else if (secaoAtiva === 'cupons') renderCupons(container);
        };

        function renderDashboard(target) {
            const f = db.fornada || { dataISO: '', diasAntecedencia: 2, horaLimite: '12h' };
            target.innerHTML = `
                <h1>Dashboard</h1>
                <div class="card-admin">
                    <h3>Configura√ß√£o da Fornada</h3>
                    <div style="display:flex; gap:15px; align-items:flex-end;">
                        <div class="form-group" style="flex:1"> <label>Data</label> <input type="date" id="f-data-iso" value="${f.dataISO}"> </div>
                        <div class="form-group" style="flex:1"> <label>Anteced√™ncia (dias)</label> <input type="number" id="f-antecedencia" value="${f.diasAntecedencia}"> </div>
                        <div class="form-group" style="flex:1"> <label>Hora Limite</label> <input type="text" id="f-hora-limite" value="${f.horaLimite}"> </div>
                        <button class="btn-adm btn-verde-personalizado" onclick="CRUD.salvarFornada({dataISO: document.getElementById('f-data-iso').value, diasAntecedencia: document.getElementById('f-antecedencia').value, horaLimite: document.getElementById('f-hora-limite').value})">Salvar</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="card-button" onclick="navegarPara('produtos')"><i class="fas fa-bread-slice"></i><h3>Produtos</h3><h2>${db.secoes.reduce((acc, s) => acc + s.itens.length, 0)}</h2></div>
                    <div class="card-button" onclick="navegarPara('sessoes')"><i class="fas fa-folder-open"></i><h3>Sess√µes</h3><h2>${db.secoes.length}</h2></div>
                </div>`;
        }

function renderProdutos(target) {
    let html = '<h1>Produtos</h1>';
    db.secoes.forEach((secao, sIdx) => {
        html += `
        <div class="card-admin linha-movivel" 
             draggable="true" 
             ondragstart="dragSessao(event, ${sIdx})" 
             ondragover="allowDrop(event)" 
             ondrop="dropSessao(event, ${sIdx})" 
             ondragend="dragEnd(event)">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; cursor: grab;">
                <h2 style="margin:0">
                    <i class="fas fa-grip-lines" style="color: #ccc; margin-right: 10px;"></i>
                    ${secao.nome}
                </h2>
                <button class="btn-adm btn-verde-personalizado" onclick="abrirModalProduto(${sIdx})">+ Novo Produto</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 30px;"></th>
                        <th class="col-img">Img</th>
                        <th>Produto</th>
                        <th class="col-preco">Pre√ßo</th>
                        <th class="col-status">Status</th>
                        <th class="col-acoes">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    ${secao.itens.map((item, iIdx) => {
                        const visivel = item.visivel !== false;
                        const disponivel = item.disponivel !== false;

                        // Defini√ß√£o de cores conforme solicitado
                        const corVerde = "#28a745";
                        const corCinzaEscuro = "#555555";

                        return `
                        <tr draggable="true" 
                            ondragstart="dragProduto(event, ${sIdx}, ${iIdx})" 
                            ondragover="allowDrop(event)" 
                            ondrop="dropProduto(event, ${sIdx}, ${iIdx})" 
                            ondragend="dragEnd(event)"
                            class="linha-movivel">
                            
                            <td style="color: #ccc; text-align: center; cursor: grab;">
                                <i class="fas fa-grip-vertical"></i>
                            </td>

                            <td><img src="${item.imagem}" style="width:40px; height:40px; border-radius:5px; object-fit:cover;"></td>
                            <td>
                                <strong>${item.nome}</strong><br>
                                <small style="color:#666">${item.descricao || ''}</small>
                                <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:5px;">
                                    ${(item.opcionais_ativos || []).map(opt => `<span class="badge-opcional-micro">${opt}</span>`).join('')}
                                </div>
                            </td>
                            <td>R$ ${item.preco.toFixed(2)}</td>
                            <td>
                                <div style="display:flex; flex-direction:column; gap:5px; align-items: center;">
                                    <button class="btn-adm" 
                                        onclick="CRUD.toggleVisibilidade(${sIdx}, ${iIdx})" 
                                        style="font-size: 0.6rem; padding: 5px; width: 85px; display: flex; justify-content: center; align-items: center; border: none; color: white; border-radius: 4px; cursor: pointer; background-color: ${visivel ? corVerde : corCinzaEscuro};">
                                        ${visivel ? 'VIS√çVEL' : 'OCULTO'}
                                    </button>
                                    <button class="btn-adm" 
                                        onclick="CRUD.toggleDisponibilidade(${sIdx}, ${iIdx})" 
                                        style="font-size: 0.6rem; padding: 5px; width: 85px; display: flex; justify-content: center; align-items: center; border: none; color: white; border-radius: 4px; cursor: pointer; background-color: ${disponivel ? corVerde : corCinzaEscuro};">
                                        ${disponivel ? 'DISPON√çVEL' : 'ESGOTADO'}
                                    </button>
                                </div>
                            </td>
                            <td>
                                <button class="btn-adm btn-bege-personalizado" onclick="abrirModalProduto(${sIdx}, ${iIdx})"><i class="fas fa-edit"></i></button>
                                <button class="btn-adm btn-red" onclick="CRUD.removerProduto(${sIdx}, ${iIdx})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>`;
    });
    target.innerHTML = html;
}

        function renderSessoes(target) {
            target.innerHTML = `
                <h1>Sess√µes</h1>
                <p style="margin-bottom: 20px; color: #666;">
                    <i class="fas fa-info-circle"></i> Clique e arraste o √≠cone <i class="fas fa-grip-lines"></i> para reordenar as categorias.
                </p>
                <button class="btn-adm btn-verde-personalizado" onclick="abrirModalSessao()">+ Nova Sess√£o</button>
                
                <div class="card-admin" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Nome da Sess√£o</th>
                                <th style="width: 150px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${db.secoes.map((s, idx) => `
                                <tr draggable="true" 
                                    ondragstart="dragSessao(event, ${idx})" 
                                    ondragover="allowDrop(event)" 
                                    ondrop="dropSessao(event, ${idx})" 
                                    ondragend="dragEnd(event)" 
                                    class="linha-movivel">
                                    <td style="color: #999; text-align: center; cursor: grab;">
                                        <i class="fas fa-grip-lines"></i>
                                    </td>
                                    <td><strong>${s.nome}</strong></td>
                                    <td>
                                        <button class="btn-adm btn-bege-personalizado" onclick="abrirModalSessao(${idx})">Editar</button>
                                        <button class="btn-adm btn-red" onclick="CRUD.removerSessao(${idx})">Excluir</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        }


        function renderCupons(target) {
            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;"> 
                    <h1 style="margin:0">Cupons</h1>
                    <button class="btn-adm btn-verde-personalizado" onclick="abrirModalCupom()">+ Novo Cupom</button>
                </div>
                
                <div class="container-cupons-lista">
                    ${db.cupons.length === 0 ? '<p>Nenhum cupom cadastrado.</p>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Desconto</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${db.cupons.map((c, idx) => `
                                    <tr>
                                        <td><strong>${c.codigo}</strong></td>
                                        <td>${c.tipo === 'porcentagem' ? c.valor + '%' : 'R$ ' + c.valor}</td>
                                        <td>
                                            <button class="btn-adm btn-red" onclick="CRUD.removerCupom(${idx})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            `;
            target.innerHTML = html;
        }

// --- BLOCO UNIFICADO DE MODAIS (PRODUTO, SESS√ÉO E CUPOM) ---

        function abrirModalProduto(sIdx, iIdx = null) {
            const item = iIdx !== null ? db.secoes[sIdx].itens[iIdx] : { nome: '', preco: 0, imagem: '', descricao: '', opcionais_ativos: [], visivel: true, disponivel: true };
            opcionaisTemp = [...(item.opcionais_ativos || [])];
            const todosOpcionais = (db.opcionais[db.secoes[sIdx].nome] || []).map(opt => opt.nome);

            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="event.preventDefault(); CRUD.salvarProduto(${sIdx}, ${iIdx})">
                    <div class="form-group">
                        <label>Nome do Produto</label>
                        <input id="f-nome" value="${item.nome}" required placeholder="Ex: Croissant de Frango">
                    </div>

                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="f-descricao" rows="2" placeholder="Detalhes do produto...">${item.descricao || ''}</textarea>
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Pre√ßo (R$)</label>
                            <input type="number" step="0.01" id="f-preco" value="${item.preco}" required>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label>Link da Imagem</label>
                            <input id="f-imagem" value="${item.imagem}" placeholder="http://...">
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; display: flex; flex-direction: column; gap: 12px; border: 1px solid #eee;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="f-visivel" ${item.visivel !== false ? 'checked' : ''} style="width: 18px; height: 18px; cursor:pointer;">
                            <label for="f-visivel" style="font-weight: bold; color: #28a745; cursor:pointer; margin:0;">VIS√çVEL NO SITE</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="f-disponivel" ${item.disponivel !== false ? 'checked' : ''} style="width: 18px; height: 18px; cursor:pointer;">
                            <label for="f-disponivel" style="font-weight: bold; color: #555; cursor:pointer; margin:0;">DISPON√çVEL EM ESTOQUE</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Opcionais Dispon√≠veis</label>
                        <div class="opcionais-badge-container" style="margin-top:5px;">
                            ${todosOpcionais.map(opt => `<div class="badge-opcional ${opcionaisTemp.includes(opt) ? 'selected' : ''}" onclick="toggleBadge('${opt}', this)">${opt}</div>`).join('')}
                        </div>
                    </div>

                    <div class="modal-footer" style="display:flex; justify-content: flex-end; gap:10px; margin-top:20px; border-top: 1px solid #eee; padding-top:15px;">
                        <button type="button" class="btn-adm btn-red" onclick="fecharModal()">Cancelar</button>
                        <button type="submit" class="btn-adm btn-verde-personalizado">Salvar Produto</button>
                    </div>
                </form>`;
                
            document.getElementById('modal-title').innerText = iIdx !== null ? "üìù Editar Produto" : "‚ú® Novo Produto";
            document.getElementById('modal-container').style.display = 'flex';
        }

        function abrirModalSessao(idx = null) {
            const sessao = idx !== null ? db.secoes[idx] : { nome: '' };
            const lista = db.opcionais[sessao.nome] || [];
            
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label>Nome da Categoria</label>
                    <input id="f-sessao-nome" value="${sessao.nome}" placeholder="Ex: Pizzas, Bebidas...">
                </div>
                
                ${idx !== null ? `
                    <div style="margin-top: 20px;">
                        <h3 style="font-size: 1rem; color: var(--verde-militar); border-bottom: 1px solid #eee; padding-bottom: 5px;">Configurar Opcionais</h3>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                            ${lista.map((opc, oIdx) => `
                                <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                                    <input style="flex:3; padding: 8px;" value="${opc.nome}" placeholder="Nome" onchange="CRUD.editarOpcional('${sessao.nome}', ${oIdx}, 'nome', this.value)">
                                    <input style="flex:1; padding: 8px;" type="number" value="${opc.preco}" placeholder="R$" onchange="CRUD.editarOpcional('${sessao.nome}', ${oIdx}, 'preco', this.value)">
                                    <button class="btn-adm btn-red" style="padding: 8px 12px;" onclick="CRUD.removerOpcional('${sessao.nome}', ${oIdx}, ${idx})">‚úï</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn-adm btn-bege-personalizado" style="width: 100%; margin-top: 10px;" onclick="CRUD.adicionarOpcional('${sessao.nome}', ${idx})">+ Adicionar Novo Opcional</button>
                    </div>
                ` : ''}

                <div class="modal-footer" style="display:flex; justify-content: flex-end; gap:10px; margin-top:25px; border-top: 1px solid #eee; padding-top:15px;">
                    <button class="btn-adm btn-red" onclick="fecharModal()">Sair</button>
                    <button class="btn-adm btn-verde-personalizado" onclick="CRUD.salvarSessao(${idx}, document.getElementById('f-sessao-nome').value)">Salvar Categoria</button>
                </div>`;
                
            document.getElementById('modal-title').innerText = idx !== null ? "üìù Gerenciar Categoria" : "‚ú® Nova Categoria";
            document.getElementById('modal-container').style.display = 'flex';
        }

        function abrirModalCupom() {
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label>C√≥digo do Cupom</label>
                    <input id="f-cupom-codigo" style="text-transform: uppercase;" placeholder="EX: PROMO10">
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Tipo</label>
                        <select id="f-cupom-tipo" style="padding: 10px; border-radius: 8px; width: 100%; height: 40px; border: 1px solid #ddd;">
                            <option value="porcentagem">Porcentagem (%)</option>
                            <option value="fixo">Valor Fixo (R$)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Valor do Desconto</label>
                        <input type="number" id="f-cupom-valor" placeholder="0">
                    </div>
                </div>

                <div class="modal-footer" style="display:flex; justify-content: flex-end; gap:10px; margin-top:20px; border-top: 1px solid #eee; padding-top:15px;">
                    <button class="btn-adm btn-red" onclick="fecharModal()">Cancelar</button>
                    <button class="btn-adm btn-verde-personalizado" onclick="CRUD.salvarCupom()">Criar Cupom</button>
                </div>`;
                
            document.getElementById('modal-title').innerText = "üéüÔ∏è Novo Cupom de Desconto";
            document.getElementById('modal-container').style.display = 'flex';
        }

        const fecharModal = () => document.getElementById('modal-container').style.display = 'none';

        function toggleBadge(nome, el) {
            const i = opcionaisTemp.indexOf(nome);
            if (i > -1) { opcionaisTemp.splice(i, 1); el.classList.remove('selected'); }
            else { opcionaisTemp.push(nome); el.classList.add('selected'); }
        }

        const baixarDados = () => {
            const dbOrdenado = { fornada: db.fornada, cupons: db.cupons, opcionais: db.opcionais, secoes: db.secoes };
            const conteudo = `const dadosIniciais = ${JSON.stringify(dbOrdenado, null, 2)};`;
            const blob = new Blob([conteudo], { type: "text/javascript" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); 
            a.href = url; a.download = "dados.js"; a.click();
        };

// --- BLOCO √öNICO DE ARRASTE (CATEGORIAS E PRODUTOS) ---
        let dragIdx = null; // Para Categorias
        let dragProdutoIdx = null; // Para Produtos
        let dragOrigemSecaoIdx = null; // Para Trava de Se√ß√£o

        // Fun√ß√µes para Categorias (Sess√µes)
        function dragSessao(e, idx) {
            dragIdx = idx;
            e.currentTarget.classList.add('dragging'); 
            e.dataTransfer.effectAllowed = 'move';
        }

        function dragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            e.currentTarget.style.opacity = '1';
        }

        function allowDrop(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function dropSessao(e, targetIdx) {
            e.preventDefault();
            if (dragIdx === null || dragIdx === targetIdx) return;
            
            const itemMovido = db.secoes.splice(dragIdx, 1)[0];
            db.secoes.splice(targetIdx, 0, itemMovido);
            
            dragIdx = null;
            CRUD.atualizarEListar();
        }

        // Fun√ß√µes para Produtos
        function dragProduto(e, sIdx, iIdx) {
            // Importante: Impede que o arraste do produto ative o arraste da categoria
            e.stopPropagation(); 
            dragProdutoIdx = iIdx;
            dragOrigemSecaoIdx = sIdx;
            e.dataTransfer.effectAllowed = 'move';
            e.currentTarget.style.opacity = '0.4';
        }

        function dropProduto(e, targetSIdx, targetIIdx) {
            e.preventDefault();
            e.stopPropagation(); // Impede conflito com o drop da categoria

            if (dragOrigemSecaoIdx !== targetSIdx) return; // Trava na mesma se√ß√£o
            if (dragProdutoIdx === null || dragProdutoIdx === targetIIdx) return;

            const lista = db.secoes[targetSIdx].itens;
            const itemMovido = lista.splice(dragProdutoIdx, 1)[0];
            lista.splice(targetIIdx, 0, itemMovido);

            dragProdutoIdx = null;
            dragOrigemSecaoIdx = null;

            CRUD.atualizarEListar();
        }

        window.onload = () => navegarPara('dashboard');
    </script>
</body>
</html>