<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo v3.1 | Pão do Ciso</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-creme: #fdf5e6;
            --verde-militar: #2d3a27;
            --verde-claro: #4a5d42;
            --marrom-cafe: #2e2610;
            --marrom-detalhe: #7d4f39;
            --texto: #3e2723;
            --branco: #ffffff;
            --red: #b22222;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            background: #f4f1ea;
            color: var(--texto);
            height: 100vh;
            overflow: hidden;
        }

        .card-link {
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s ease;
        }

        .card-link:hover {
            transform: translateY(-5px);
        }

        .stat-card {
            height: 100%; /* Garante que todos tenham o mesmo tamanho */
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--verde-militar);
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .logo-area {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-area h2 {
            color: var(--bg-creme);
            margin: 0;
            font-size: 1.4rem;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #ccc;
            text-decoration: none;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1rem;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: var(--branco);
            border-left: 4px solid var(--bg-creme);
        }

        .nav-item i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .action-area {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .btn-action {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.2s;
            margin-bottom: 10px;
        }

        .btn-save { background: var(--bg-creme); color: var(--verde-militar); }
        .btn-save:hover { background: #fff; transform: translateY(-2px); }

        .btn-download { background: var(--marrom-detalhe); color: white; }
        .btn-download:hover { background: #653d2b; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 { color: var(--verde-militar); margin: 0; }

        /* --- CARDS & GRID --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--verde-militar);
        }

        .stat-value { font-size: 2rem; font-weight: bold; color: var(--verde-militar); }
        .stat-label { color: #666; font-size: 0.9rem; text-transform: uppercase; }

        /* --- SEÇÕES & TABELAS (CORRIGIDO PARA ALINHAMENTO) --- */
        .secao-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
        }

        .secao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg-creme);
            margin-bottom: 15px;
            cursor: move;
        }

        .secao-titulo { font-size: 1.2rem; font-weight: bold; color: var(--verde-militar); display: flex; align-items: center; gap: 10px; }

        /* Tabela Fixa para Alinhamento */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: fixed; /* Força colunas iguais entre tabelas diferentes */
        }
        
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { color: var(--verde-militar); font-weight: 600; font-size: 0.9rem; text-transform: uppercase; }
        
        /* Larguras fixas das colunas */
        .col-drag { width: 40px; text-align: center; }
        .col-prod { width: auto; } /* Flexível */
        .col-preco { width: 100px; }
        .col-status { width: 160px; text-align: center; }
        .col-acoes { width: 120px; text-align: right; }

        /* --- BADGES E BOTÕES --- */
        .btn-icon {
            background: none; border: none; cursor: pointer; color: #666; font-size: 1.1rem; transition: 0.2s; padding: 5px;
        }
        .btn-icon:hover { color: var(--marrom-detalhe); transform: scale(1.1); }
        .btn-add { background: var(--verde-militar); color: white; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; border: none; cursor: pointer;}

        /* Botões de Status (Toggle) */
        .btn-toggle {
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            background: white;
            color: #999;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
            margin: 0 2px;
        }

        .btn-toggle:hover { background: #f5f5f5; }

        .btn-toggle.ativo {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #c8e6c9;
            font-weight: bold;
        }
        
        .btn-toggle.esgotado {
            background: #ffebee;
            color: #c62828;
            border-color: #ffcdd2;
            font-weight: bold;
        }

        /* Tags de Opcionais (Lista) */
        .tag-mini {
            display: inline-block;
            font-size: 0.7rem;
            background: #f0f0f0;
            color: #555;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
            margin-top: 4px;
        }

        /* --- MODAIS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--verde-militar); }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;
            box-sizing: border-box; font-family: inherit;
        }
        
        /* BALÕES DE SELEÇÃO (MODAL) */
        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .badge-select {
            padding: 8px 16px;
            border-radius: 20px;
            background: #fff;
            border: 1px solid #ccc;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge-select:hover { transform: translateY(-2px); border-color: #999; }
        
        .badge-select.selected {
            background: var(--verde-militar);
            color: white;
            border-color: var(--verde-militar);
            font-weight: 500;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel { background: #eee; color: #333; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-confirm { background: var(--verde-militar); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }

        /* --- LOGISTICA --- */
        .taxa-geral-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bbdefb;
            color: #0d47a1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-area">
            <h2><i class="fas fa-bread-slice"></i> Gestor V3.1</h2>
        </div>
        <nav class="nav-menu">
            <div class="nav-item" id="nav-dashboard" onclick="navegarPara('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
            </div>
            <div class="nav-item" id="nav-produtos" onclick="navegarPara('produtos')">
                <i class="fas fa-utensils"></i> Produtos
            </div>
            <div class="nav-item" id="nav-logistica" onclick="navegarPara('logistica')">
                <i class="fas fa-motorcycle"></i> Logística
            </div>
            <div class="nav-item" id="nav-cupons" onclick="navegarPara('cupons')">
                <i class="fas fa-ticket-alt"></i> Cupons
            </div>
        </nav>
        <div class="action-area">

<button class="btn-action" style="background: #4a5d42; color: white;" onclick="carregarDadosJS()">
    <i class="fas fa-sync"></i> Recarregar dados.js
</button>

            <button class="btn-action btn-save" onclick="persistir()">
                <i class="fas fa-save"></i> Salvar Local
            </button>
            <button class="btn-action btn-download" onclick="baixarDados()">
                <i class="fas fa-download"></i> Baixar dados.js
            </button>
        </div>
    </div>

    <div class="main-content" id="conteudo-principal">
        </div>

    <div class="modal-overlay" id="modal-container"></div>



<script>
    // ===========================================
    // 1. ESTADO E DADOS
    // ===========================================
    const estadoInicial = {
        loja: { nome: "Pão do Ciso", telefone: "", endereco: "" }, // Adicione esta linha
        fornada: { dataISO: new Date().toISOString().split('T')[0], diasAntecedencia: 2, horaLimite: "23:59h" },
        entrega: { taxaGeral: 10.00, bairros: [] },
        cupons: [],
        secoes: [{ nome: "Pães Artesanais", itens: [] }],
        opcionais: { "Pães Artesanais": [] }
    };

    let db = JSON.parse(localStorage.getItem('pao_do_ciso_db')) || estadoInicial;
    let secaoAtiva = 'dashboard';
    
    // Variáveis Drag & Drop
    let dragIdx = null;
    let dragProdutoIdx = null; 
    let dragOrigemSecaoIdx = null;


    function carregarDadosJS() {
        // Remove scripts de carga anteriores para evitar duplicidade
        const scriptsAntigos = document.querySelectorAll('.script-dados-carga');
        scriptsAntigos.forEach(s => s.remove());

        const script = document.createElement('script');
        // O timestamp (?v=...) força o navegador a ler o arquivo do disco, ignorando o cache
        script.src = './js/dados.js?v=' + new Date().getTime();
        script.className = 'script-dados-carga';
        
        script.onload = function() {
            if (window.dadosIniciais) {
                // Sobrescreve o db com os dados vindos do arquivo
                db = window.dadosIniciais;
                console.log('Dados carregados do arquivo dados.js com sucesso!');
                renderizarAtual();
            }
        };

        script.onerror = function() {
            console.warn('Arquivo dados.js não encontrado ou erro na leitura. Usando dados locais.');
        };

        document.head.appendChild(script);
    }

    // ===========================================
    // 2. INICIALIZAÇÃO
    // ===========================================
    window.onload = function() {
        // 1. Carrega os dados do arquivo ou localStorage
        carregarDadosJS();
        
        // 2. Busca o container da aba dashboard
        const dashContainer = document.getElementById('tab-dashboard');
        
        // 3. Renderiza os novos cards com links
        if (dashContainer) {
            renderDashboard(dashContainer);
        }
        
        // 4. Abre na visão geral por padrão
        navegarPara('dashboard');
    }; // <--- Verifique se há apenas um fechamento aqui

    function navegarPara(secao) {
        secaoAtiva = secao;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-' + secao).classList.add('active');
        renderizarAtual();
    }

    function renderizarAtual() {
        const container = document.getElementById('conteudo-principal');
        container.innerHTML = '';

        switch(secaoAtiva) {
            case 'dashboard': renderDashboard(container); break;
            case 'produtos': renderProdutos(container); break;
            case 'logistica': renderLogistica(container); break;
            case 'cupons': renderCupons(container); break;
        }
    }

    // ===========================================
    // 3. RENDERIZAÇÃO
    // ===========================================
    function renderDashboard(container) {
        if (!container) return;

        const totalProdutos = db.secoes.reduce((acc, s) => acc + s.itens.length, 0);
        const totalBairros = db.entrega.bairros.length;
        
        container.innerHTML = `
            <header><h1><i class="fas fa-chart-line"></i> Visão Geral</h1></header>
            
            <div class="secao-container" style="margin-bottom: 30px; border: 1px solid #ddd; border-radius: 8px; background: #fff; box-shadow: var(--shadow);">
                <div class="secao-header" style="background: var(--verde-militar); color: white; border-radius: 8px 8px 0 0; padding: 15px;">
                    <div class="secao-titulo" style="color: white;">
                        <i class="far fa-calendar-alt"></i> DATA DA PRÓXIMA FORNADA
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 25px;">
                    <div class="form-group">
                        <label style="font-weight: bold; color: var(--marrom-detalhe);">Data de Entrega</label>
                        <input type="date" id="dash-data" value="${db.fornada.dataISO}" onchange="CRUD.atualizarFornada()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: bold; color: var(--marrom-detalhe);">Antecedência (Dias)</label>
                        <input type="number" id="dash-dias" value="${db.fornada.diasAntecedencia}" onchange="CRUD.atualizarFornada()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: bold; color: var(--marrom-detalhe);">Hora Limite</label>
                        <input type="text" id="dash-hora" value="${db.fornada.horaLimite}" onchange="CRUD.atualizarFornada()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </div>

            <div class="stats-grid" style="margin-bottom: 40px;">
                <div class="stat-card" onclick="navegarPara('produtos')" style="cursor:pointer !important;">
                    <div class="stat-value">${totalProdutos}</div>
                    <div class="stat-label">Produtos <i class="fas fa-chevron-right" style="font-size:0.7rem"></i></div>
                </div>

                <div class="stat-card" onclick="navegarPara('cupons')" style="cursor:pointer !important;">
                    <div class="stat-value">${db.cupons.length}</div>
                    <div class="stat-label">Cupons <i class="fas fa-chevron-right" style="font-size:0.7rem"></i></div>
                </div>

                <div class="stat-card" onclick="navegarPara('logistica')" style="cursor:pointer !important; border-bottom: 4px solid var(--marrom-detalhe);">
                    <div class="stat-value">${totalBairros}</div>
                    <div class="stat-label">Bairros Atendidos <i class="fas fa-chevron-right" style="font-size:0.7rem"></i></div>
                </div>

                <div class="stat-card" onclick="navegarPara('logistica')" style="cursor:pointer !important;">
                    <div class="stat-value">R$ ${parseFloat(db.entrega.taxaGeral).toFixed(2)}</div>
                    <div class="stat-label">Taxa Geral <i class="fas fa-chevron-right" style="font-size:0.7rem"></i></div>
                </div>
            </div>
        `;
    }

    function renderProdutos(container) {
        let html = `
            <header>
                <h1><i class="fas fa-utensils"></i> Gerenciar Cardápio</h1>
                <button class="btn-action btn-add" onclick="CRUD.novaSessao()" style="width: auto;"><i class="fas fa-plus"></i> Nova Categoria</button>
            </header>
        `;

        db.secoes.forEach((sessao, sIdx) => {
            html += `
                <div class="secao-container" draggable="true" ondragstart="dragSessao(event, ${sIdx})" ondrop="dropSessao(event, ${sIdx})" ondragover="allowDrop(event)">
                    <div class="secao-header">
                        <div class="secao-titulo"><i class="fas fa-grip-vertical drag-handle"></i> ${sessao.nome}</div>
                        <div>
                            <button class="btn-icon" onclick="CRUD.editarSessao(${sIdx})" title="Configurar Categoria"><i class="fas fa-cog"></i></button>
                            <button class="btn-icon" onclick="CRUD.novoProduto(${sIdx})" title="Novo Produto"><i class="fas fa-plus-circle"></i></button>
                            <button class="btn-icon" onclick="CRUD.removerSessao(${sIdx})" title="Excluir"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th class="col-drag"></th>
                                <th class="col-prod">Produto</th>
                                <th class="col-preco">Preço</th>
                                <th class="col-status">Status (Ações Rápidas)</th>
                                <th class="col-acoes">Editar</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (sessao.itens.length === 0) {
                html += `<tr><td colspan="5" style="text-align:center; color:#999; padding: 20px;">Categoria vazia.</td></tr>`;
            } else {
                sessao.itens.forEach((item, iIdx) => {
                    // Renderização dos Balões de Opcionais na Lista
                    const tagsHtml = (item.opcionais_ativos || []).map(opt => `<span class="tag-mini">${opt}</span>`).join('');

                    // Estado dos botões de Toggle
                    const visivelClass = item.visivel ? 'ativo' : '';
                    const visivelIcon = item.visivel ? 'fa-eye' : 'fa-eye-slash';
                    const visivelText = item.visivel ? 'Visível' : 'Oculto';

                    const esgotadoClass = item.esgotado ? 'esgotado' : 'ativo';
                    const esgotadoIcon = item.esgotado ? 'fa-ban' : 'fa-check';
                    const esgotadoText = item.esgotado ? 'Esgotado' : 'Disp.';

                    html += `
                        <tr draggable="true" ondragstart="dragProduto(event, ${sIdx}, ${iIdx})" ondrop="dropProduto(event, ${sIdx}, ${iIdx})" ondragover="allowDrop(event)">
                            <td class="col-drag"><i class="fas fa-bars drag-handle" style="color:#ddd"></i></td>
                            <td class="col-prod">
                                <div style="font-weight:bold;">${item.nome}</div>
                                <div style="font-size:0.8rem; color:#666;">${item.descricao.substring(0, 40)}...</div>
                                <div>${tagsHtml}</div>
                            </td>
                            <td class="col-preco">R$ ${parseFloat(item.preco).toFixed(2)}</td>
                            <td class="col-status">
                                <button class="btn-toggle ${visivelClass}" onclick="CRUD.toggleVisibilidade(${sIdx}, ${iIdx})" title="Mostrar/Ocultar no site">
                                    <i class="fas ${visivelIcon}"></i>
                                </button>
                                <button class="btn-toggle ${esgotadoClass}" onclick="CRUD.toggleEsgotado(${sIdx}, ${iIdx})" title="Marcar como Disponível/Esgotado">
                                    <i class="fas ${esgotadoIcon}"></i>
                                </button>
                            </td>
                            <td class="col-acoes">
                                <button class="btn-icon" onclick="CRUD.editarProduto(${sIdx}, ${iIdx})"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon" onclick="CRUD.duplicarProduto(${sIdx}, ${iIdx})"><i class="fas fa-copy"></i></button>
                                <button class="btn-icon" onclick="CRUD.removerProduto(${sIdx}, ${iIdx})" style="color:var(--red);"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table></div>`;
        });
        container.innerHTML = html;
    }

    function renderLogistica(container) {
        if (!container) return;

        container.innerHTML = `
            <header><h1><i class="fas fa-truck"></i> Logística e Entrega</h1></header>
            
            <div class="secao-container" style="margin-bottom:20px;">
                <div class="secao-header"><div class="secao-titulo">Taxa de Entrega Geral</div></div>
                <div style="padding: 20px;">
                    <div class="form-group" style="max-width: 200px;">
                        <label>Valor Padrão (R$)</label>
                        <input type="number" step="0.5" value="${db.entrega.taxaGeral}" 
                            onchange="db.entrega.taxaGeral = parseFloat(this.value); persistir();">
                    </div>
                </div>
            </div>

            <div class="secao-container">
                <div class="secao-header"><div class="secao-titulo">Bairros e Taxas Específicas</div></div>
                <div style="padding: 20px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid #eee;">
                                <th style="padding: 10px;">Bairro</th>
                                <th style="padding: 10px; width: 150px;">Taxa (R$)</th>
                                <th style="padding: 10px; width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-bairros">
                            </tbody>
                    </table>
                </div>
            </div>
        `;
        // Chama a função que desenha as linhas pela primeira vez
        atualizarTabelaBairros();
    }

    function atualizarTabelaBairros() {
        const corpo = document.getElementById('corpo-tabela-bairros');
        if (!corpo) return;

        let html = '';
        // Renderiza bairros existentes usando a propriedade .taxa
        db.entrega.bairros.forEach((b, idx) => {
            html += `
                <tr style="border-bottom: 1px solid #f4f4f4;">
                    <td style="padding: 8px;">
                        <input type="text" value="${b.nome}" 
                            onchange="db.entrega.bairros[${idx}].nome = this.value; persistir();" 
                            style="width: 95%; padding: 5px;">
                    </td>
                    <td style="padding: 8px;">
                        <input type="number" step="0.5" value="${b.taxa || 0}" 
                            onchange="db.entrega.bairros[${idx}].taxa = parseFloat(this.value); persistir();" 
                            style="width: 95%; padding: 5px;">
                    </td>
                    <td style="padding: 8px;">
                        <button onclick="db.entrega.bairros.splice(${idx}, 1); persistir(); atualizarTabelaBairros();" 
                            style="background:none; border:none; color:#e74c3c; cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        // Mantém a linha de input para novo cadastro no final
        html += `
            <tr style="background: #fdfdfd;">
                <td style="padding: 8px;">
                    <input type="text" id="novo-bairro-nome" placeholder="Nome do bairro..." 
                        style="width: 95%; padding: 5px; border: 1px dashed #ccc;">
                </td>
                <td style="padding: 8px;">
                    <input type="number" id="novo-bairro-taxa" step="0.5" placeholder="0.00" 
                        onchange="tentarAdicionarBairro()" 
                        onkeydown="if(event.key==='Enter') tentarAdicionarBairro()" 
                        style="width: 95%; padding: 5px; border: 1px dashed #ccc;">
                </td>
                <td></td>
            </tr>
        `;

        corpo.innerHTML = html;
    }

    function tentarAdicionarBairro() {
        const inputNome = document.getElementById('novo-bairro-nome');
        const inputTaxa = document.getElementById('novo-bairro-taxa');
        
        const nome = inputNome.value.trim();
        const taxaStr = inputTaxa.value;

        if (nome !== "" && taxaStr !== "") {
            db.entrega.bairros.push({ 
                nome: nome, 
                taxa: parseFloat(taxaStr) || 0 // Alterado de 'valor' para 'taxa'
            });
            
            persistir();
            atualizarTabelaBairros();
            
            setTimeout(() => {
                const proxNome = document.getElementById('novo-bairro-nome');
                if(proxNome) proxNome.focus();
            }, 50);
        }
    }

    // Função auxiliar para gerar as linhas
    function renderizarLinhasBairros() {
        let html = '';
        // Linhas existentes
        db.entrega.bairros.forEach((b, idx) => {
            html += `
                <tr>
                    <td><input type="text" value="${b.nome}" onchange="atualizarBairro(${idx}, 'nome', this.value)" style="width: 95%;"></td>
                    <td><input type="number" step="0.5" value="${b.taxa}" onchange="atualizarBairro(${idx}, 'taxa', this.value)" style="width: 95%;"></td>
                    <td><button onclick="removerBairro(${idx})" style="background:none; border:none; color:red; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
        });
        // Linha Vazia - Agora com ID específico para o input de gatilho
        html += `
            <tr style="background: #f9f9f9;">
                <td><input type="text" id="novo-bairro-nome" placeholder="Novo bairro..." onchange="verificarNovaLinha()" style="width: 95%;"></td>
                <td><input type="number" id="novo-bairro-taxa" step="0.5" placeholder="0.00" onchange="verificarNovaLinha()" style="width: 95%;"></td>
                <td></td>
            </tr>
        `;
        return html;
    }

    function atualizarBairro(idx, campo, valor) {
        if (campo === 'taxa') valor = parseFloat(valor) || 0;
        db.entrega.bairros[idx][campo] = valor;
        persistir();
        // Não precisa renderizar tudo de novo aqui para não perder o foco enquanto edita
    }

    function removerBairro(idx) {
        if (confirm('Remover este bairro?')) {
            db.entrega.bairros.splice(idx, 1);
            persistir();
            renderLogistica(document.getElementById('tab-logistica'));
        }
    }

    function verificarNovaLinha() {
        const nomeInput = document.getElementById('novo-bairro-nome');
        const taxaInput = document.getElementById('novo-bairro-taxa');
        
        const nome = nomeInput.value.trim();
        const taxa = taxaInput.value;

        // Dispara a criação se o nome for preenchido e você sair do campo ou der Enter
        if (nome !== "") {
            db.entrega.bairros.push({
                nome: nome,
                taxa: parseFloat(taxa) || 0
            });
            
            persistir();
            
            // RERENDERIZAÇÃO IMEDIATA:
            // Buscamos o container da aba de logística e chamamos a renderização
            const container = document.getElementById('tab-logistica');
            renderLogistica(container);
            
            // Coloca o foco no novo campo de nome para você continuar cadastrando
            const novoInput = document.getElementById('novo-bairro-nome');
            if (novoInput) novoInput.focus();
        }
    }

    function renderCupons(container) {
        let html = `<header><h1><i class="fas fa-ticket-alt"></i> Cupons</h1><button class="btn-action btn-add" onclick="CRUD.modalCupom()" style="width:auto;">+ Cupom</button></header><div class="secao-container"><table><thead><tr><th>Código</th><th>Tipo</th><th>Valor</th><th>Ações</th></tr></thead><tbody>`;
        db.cupons.forEach((c, idx) => {
            html += `<tr><td><strong>${c.codigo}</strong></td><td>${c.tipo}</td><td>${c.valor}</td><td><button class="btn-icon" onclick="CRUD.removerCupom(${idx})" style="color:var(--red)"><i class="fas fa-trash"></i></button></td></tr>`;
        });
        html += `</tbody></table></div>`;
        container.innerHTML = html;
    }

    // ===========================================
    // 4. CRUD LÓGICA
    // ===========================================
    const CRUD = {
        atualizarFornada: () => {
            db.fornada.dataISO = document.getElementById('dash-data').value;
            db.fornada.diasAntecedencia = parseInt(document.getElementById('dash-dias').value);
            db.fornada.horaLimite = document.getElementById('dash-hora').value;
            persistir();
        },

        novaSessao: () => {
            const nome = prompt("Nome da nova categoria:");
            if (nome) { db.secoes.push({ nome, itens: [] }); db.opcionais[nome] = []; renderizarAtual(); persistir(); }
        },

        removerSessao: (idx) => { if(confirm('Apagar categoria?')) { delete db.opcionais[db.secoes[idx].nome]; db.secoes.splice(idx, 1); renderizarAtual(); persistir(); } },
        
        editarSessao: (idx) => {
            const secao = db.secoes[idx];
            const ops = db.opcionais[secao.nome] || [];
            let listaOpsHtml = ops.map((op, i) => `
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" value="${op.nome}" id="op-nome-${i}" style="flex:2">
                    <input type="number" step="0.5" value="${op.preco}" id="op-preco-${i}" style="width:80px;">
                    <button onclick="CRUD.rmOpTemp(${idx}, ${i})" style="background:#ecc; border:none; cursor:pointer;">X</button>
                </div>`).join('');
            
            const html = `<h2>Editar Categoria</h2><input type="text" id="edit-cat-nome" value="${secao.nome}" class="form-group" style="width:100%; padding:10px; margin-bottom:10px;">
                <h3>Opcionais da Categoria</h3><div id="lista-ops-container">${listaOpsHtml}</div>
                <button class="btn-action btn-add" onclick="CRUD.addOpTemp(${idx})">+ Opcional</button>
                <div class="modal-footer"><button class="btn-cancel" onclick="fecharModal()">Cancelar</button><button class="btn-confirm" onclick="CRUD.salvarSessao(${idx})">Salvar</button></div>`;
            abrirModalContent(html);
        },

        addOpTemp: (sIdx) => { 
            const n = db.secoes[sIdx].nome; 
            if(!db.opcionais[n]) db.opcionais[n]=[]; 
            db.opcionais[n].push({nome:"Novo", preco:0}); 
            CRUD.editarSessao(sIdx); 
        },

        rmOpTemp: (sIdx, oIdx) => { db.opcionais[db.secoes[sIdx].nome].splice(oIdx, 1); CRUD.editarSessao(sIdx); },
        salvarSessao: (idx) => {
            const novoNome = document.getElementById('edit-cat-nome').value;
            const antigoNome = db.secoes[idx].nome;
            const opsAtualizados = Array.from(document.querySelectorAll('#lista-ops-container > div')).map((div, i) => ({
                nome: document.getElementById(`op-nome-${i}`).value,
                preco: parseFloat(document.getElementById(`op-preco-${i}`).value)
            }));
            if(novoNome !== antigoNome) delete db.opcionais[antigoNome];
            db.opcionais[novoNome] = opsAtualizados;
            db.secoes[idx].nome = novoNome;
            fecharModal(); renderizarAtual(); persistir();
        },

        novoProduto: (sIdx) => {
            db.secoes[sIdx].itens.push({ nome: "Novo Produto", descricao: "", preco: 0, imagem: "img/padrao.jpg", visivel: true, esgotado: false, opcionais_ativos: [] });
            renderizarAtual();
            CRUD.editarProduto(sIdx, db.secoes[sIdx].itens.length - 1);
        },
        
        // TOGGLES RÁPIDOS DA COLUNA STATUS
        toggleVisibilidade: (sIdx, pIdx) => {
            const item = db.secoes[sIdx].itens[pIdx];
            item.visivel = !item.visivel;
            renderizarAtual();
            persistir();
        },

        toggleEsgotado: (sIdx, pIdx) => {
            const item = db.secoes[sIdx].itens[pIdx];
            item.esgotado = !item.esgotado;
            renderizarAtual();
            persistir();
        },

        selecionarArquivo: (input) => {
            if (input.files && input.files[0]) {
                // Pega apenas o nome do arquivo (ex: "pao-italiano.jpg")
                const nomeArquivo = input.files[0].name;
                
                // Atualiza o campo de texto no modal com o prefixo da sua pasta de imagens
                document.getElementById('prod-img').value = "img/" + nomeArquivo;
            }
        },

        editarProduto: (sIdx, pIdx) => {
            const item = db.secoes[sIdx].itens[pIdx];
            const todosOps = db.opcionais[db.secoes[sIdx].nome] || [];
            
            const html = `
                <h2>Editar Produto</h2>
                
                <div class="form-group">
                    <label>Nome do Produto</label>
                    <div style="display: flex; gap: 5px;">
                        <input id="prod-nome" value="${item.nome}" style="flex: 1;">
                        <button type="button" class="btn-action" style="width: auto; margin: 0; background: #4285F4; color: white; padding: 0 15px;" 
                            title="Buscar no Google"
                            onclick="window.open('https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(document.getElementById('prod-nome').value), '_blank')">
                            <i class="fab fa-google"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Status e Disponibilidade</label>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="btn-modal-vis" class="btn-toggle ${item.visivel ? 'ativo' : ''}" style="flex: 1; justify-content: center; padding: 10px;" 
                            onclick="this.classList.toggle('ativo'); const i = this.querySelector('i'); i.classList.toggle('fa-eye'); i.classList.toggle('fa-eye-slash'); this.querySelector('span').textContent = this.classList.contains('ativo') ? 'Visível' : 'Oculto';">
                            <i class="fas ${item.visivel ? 'fa-eye' : 'fa-eye-slash'}"></i> <span style="margin-left:8px">${item.visivel ? 'Visível' : 'Oculto'}</span>
                        </button>
                        
                        <button type="button" id="btn-modal-esg" class="btn-toggle ${item.esgotado ? 'esgotado' : 'ativo'}" style="flex: 1; justify-content: center; padding: 10px;"
                            onclick="this.classList.toggle('esgotado'); this.classList.toggle('ativo'); const i = this.querySelector('i'); i.classList.toggle('fa-ban'); i.classList.toggle('fa-check'); this.querySelector('span').textContent = this.classList.contains('esgotado') ? 'Esgotado' : 'Disponível';">
                            <i class="fas ${item.esgotado ? 'fa-ban' : 'fa-check'}"></i> <span style="margin-left:8px">${item.esgotado ? 'Esgotado' : 'Disponível'}</span>
                        </button>
                    </div>
                </div>

                <div class="form-group"><label>Descrição</label><textarea id="prod-desc" rows="3">${item.descricao}</textarea></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group"><label>Preço (R$)</label><input type="number" step="0.5" id="prod-preco" value="${item.preco}"></div>
                    
                    <div class="form-group">
                        <label>Imagem</label>
                        <div style="display: flex; gap: 5px;">
                            <input id="prod-img" value="${item.imagem}" readonly style="flex: 1; background: #f0f0f0; cursor: not-allowed;">
                            <button type="button" class="btn-action" style="width: auto; margin: 0; padding: 0 15px; background: #7d4f39; color: white;" onclick="document.getElementById('file-input').click()">
                                <i class="fas fa-folder-open"></i>
                            </button>
                        </div>
                        <input type="file" id="file-input" style="display: none;" onchange="CRUD.selecionarArquivo(this)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Opcionais (Clique para ativar)</label>
                    <div class="badges-container">
                        ${todosOps.length === 0 
                            ? '<p style="color:#999; font-size:0.9rem;">Nenhum opcional configurado.</p>' 
                            : todosOps.map(op => {
                                const isSelected = (item.opcionais_ativos || []).includes(op.nome);
                                return `<div class="badge-select ${isSelected ? 'selected' : ''}" onclick="this.classList.toggle('selected')" data-val="${op.nome}">${op.nome} (+R$${op.preco})</div>`;
                            }).join('')
                        }
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn-cancel" onclick="fecharModal()">Cancelar</button>
                    <button class="btn-confirm" onclick="CRUD.salvarProduto(${sIdx}, ${pIdx})">Salvar</button>
                </div>
            `;
            abrirModalContent(html);
        },
   
        salvarProduto: (sIdx, pIdx) => {
            const item = db.secoes[sIdx].itens[pIdx];
            
            // Campos de texto e número
            item.nome = document.getElementById('prod-nome').value;
            item.descricao = document.getElementById('prod-desc').value;
            item.preco = parseFloat(document.getElementById('prod-preco').value);
            item.imagem = document.getElementById('prod-img').value;
            
            // CAPTURA DOS NOVOS STATUS DO MODAL
            // Verifica se o botão de visibilidade tem a classe 'ativo'
            item.visivel = document.getElementById('btn-modal-vis').classList.contains('ativo');
            
            // Verifica se o botão de estoque tem a classe 'esgotado'
            item.esgotado = document.getElementById('btn-modal-esg').classList.contains('esgotado');

            // Captura dos Opcionais (Badges selecionadas)
            const selecionados = Array.from(document.querySelectorAll('.badge-select.selected'))
                                    .map(el => el.getAttribute('data-val'));
            item.opcionais_ativos = selecionados;

            // Finalização padrão
            fecharModal();
            renderizarAtual();
            persistir();
        },
        
        duplicarProduto: (sIdx, pIdx) => {
            const novo = JSON.parse(JSON.stringify(db.secoes[sIdx].itens[pIdx]));
            novo.nome += " (Cópia)";
            db.secoes[sIdx].itens.push(novo);
            renderizarAtual(); persistir();
        },

        removerProduto: (sIdx, pIdx) => { if(confirm('Excluir?')) { db.secoes[sIdx].itens.splice(pIdx, 1); renderizarAtual(); persistir(); } },
        
        // Logística e Cupons (Simples)
        atualizarTaxaGeral: (v) => { db.entrega.taxaGeral = parseFloat(v); persistir(); },
        modalBairro: (idx=null) => {
            const b = idx!==null ? db.entrega.bairros[idx] : {nome:'', valor:0};
            const html = `<h2>Bairro</h2><input id="b-nome" value="${b.nome}" placeholder="Nome" class="form-group" style="width:100%; padding:10px; margin-bottom:10px;"><input id="b-val" type="number" value="${b.valor}" placeholder="Valor" class="form-group" style="width:100%; padding:10px;"><div class="modal-footer"><button class="btn-confirm" onclick="CRUD.salvarBairro(${idx})">Salvar</button></div>`;
            abrirModalContent(html);
        },

        salvarBairro: (idx) => {
            const novo = { nome: document.getElementById('b-nome').value, valor: parseFloat(document.getElementById('b-val').value) };
            if(idx!==null) db.entrega.bairros[idx] = novo; else db.entrega.bairros.push(novo);
            fecharModal(); renderizarAtual(); persistir();
        },

        removerBairro: (idx) => { 
            if(confirm('Excluir este bairro?')) {
                db.entrega.bairros.splice(idx, 1); 
                persistir(); 
                // Garante que a tabela seja redesenhada usando a nova lógica de 'taxa'
                atualizarTabelaBairros();
            }
        },

        modalCupom: () => {
             const html = `<h2>Cupom</h2><input id="c-cod" placeholder="Código" style="text-transform:uppercase; width:100%; padding:10px; margin-bottom:10px;"><select id="c-tipo" style="width:100%; padding:10px; margin-bottom:10px;"><option value="porcentagem">%</option><option value="fixo">R$</option></select><input id="c-val" type="number" placeholder="Valor" style="width:100%; padding:10px;"><div class="modal-footer"><button class="btn-confirm" onclick="CRUD.salvarCupom()">Salvar</button></div>`;
             abrirModalContent(html);
        },
        salvarCupom: () => {
            db.cupons.push({ codigo: document.getElementById('c-cod').value.toUpperCase(), tipo: document.getElementById('c-tipo').value, valor: parseFloat(document.getElementById('c-val').value) });
            fecharModal(); renderizarAtual(); persistir();
        },

        removerCupom: (idx) => { db.cupons.splice(idx, 1); renderizarAtual(); persistir(); }
    };

    // ===========================================
    // 5. DRAG AND DROP & UTILS
    // ===========================================
    function allowDrop(ev) { ev.preventDefault(); }
    function dragSessao(e, idx) { dragIdx = idx; e.dataTransfer.effectAllowed = 'move'; }
    function dropSessao(e, tIdx) { e.preventDefault(); if(dragIdx===null || dragIdx===tIdx) return; const i = db.secoes.splice(dragIdx, 1)[0]; db.secoes.splice(tIdx, 0, i); dragIdx=null; renderizarAtual(); persistir(); }
    
    function dragProduto(e, s, i) { e.stopPropagation(); dragProdutoIdx=i; dragOrigemSecaoIdx=s; e.dataTransfer.effectAllowed='move'; }
    function dropProduto(e, ts, ti) { e.preventDefault(); e.stopPropagation(); if(dragOrigemSecaoIdx!==ts || dragProdutoIdx===null || dragProdutoIdx===ti) return; const l = db.secoes[ts].itens; l.splice(ti, 0, l.splice(dragProdutoIdx, 1)[0]); dragProdutoIdx=null; renderizarAtual(); persistir(); }

    function abrirModalContent(html) { const c = document.getElementById('modal-container'); c.innerHTML = `<div class="modal">${html}</div>`; c.style.display = 'flex'; }
    function fecharModal() { document.getElementById('modal-container').style.display = 'none'; }
    document.getElementById('modal-container').addEventListener('click', (e) => { if(e.target.id === 'modal-container') fecharModal(); });
    
    function persistir() { localStorage.setItem('pao_do_ciso_db', JSON.stringify(db)); const btn = document.querySelector('.btn-save'); const org = btn.innerHTML; btn.innerHTML = '<i class="fas fa-check"></i> Salvo!'; setTimeout(() => btn.innerHTML = org, 1500); }
    
    // Esta função garante a ordem lógica que você solicitou ao salvar o arquivo
    function gerarConteudoDadosJS() {
        let conteudo = "// ============================================\n";
        conteudo += "// DADOS DO SISTEMA - PÃO DO CISO\n";
        conteudo += "// ============================================\n\n";
        conteudo += "window.dadosIniciais = {\n";

        // 1º - LOJA
        conteudo += `    loja: ${JSON.stringify(db.loja, null, 3)},\n\n`;

        // 2º - DADOS DA FORNADA
        conteudo += `    fornada: ${JSON.stringify(db.fornada, null, 3)},\n\n`;

        // NOVO: DADOS DE ENTREGA (Logística)
        conteudo += `    entrega: ${JSON.stringify(db.entrega, null, 3)},\n\n`;

        // 3º - DADOS DOS CUPONS
        conteudo += `    cupons: ${JSON.stringify(db.cupons, null, 3)},\n\n`;

        // 4º - OPCIONAIS
        conteudo += `    opcionais: ${JSON.stringify(db.opcionais, null, 3)},\n\n`;

        // 5º - SEÇÕES
        conteudo += `    secoes: ${JSON.stringify(db.secoes, null, 3)}\n`;

        conteudo += "};";
        return conteudo;
    }

    // Função de baixar atualizada para usar a nova organização
    function baixarDados() {
        const conteudo = gerarConteudoDadosJS();
        const blob = new Blob([conteudo], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dados.js';
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>